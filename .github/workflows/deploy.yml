name: Deploy Extension

on:
  push:
    tags:
      - "*"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.9.0

      - name: Install dependencies
        run: pnpm install

      - name: Publish to Open VSX Registry
        uses: HaaLeo/publish-vscode-extension@v2
        id: publishToOpenVSX
        with:
          pat: ${{ secrets.OPEN_VSX_TOKEN }}
          skipDuplicate: true
          dependencies: false
        continue-on-error: true

      - name: Publish to Visual Studio Marketplace
        uses: HaaLeo/publish-vscode-extension@v2
        id: publishToVSMarketplace
        with:
          pat: ${{ secrets.VS_MARKETPLACE_TOKEN }}
          registryUrl: https://marketplace.visualstudio.com
          extensionFile: ${{ steps.publishToOpenVSX.outputs.vsixPath }}
          skipDuplicate: true
          dependencies: false
        continue-on-error: true

      - name: Check deployment results
        run: |
          echo "OpenVSX deployment: ${{ steps.publishToOpenVSX.outcome }}"
          echo "VS Marketplace deployment: ${{ steps.publishToVSMarketplace.outcome }}"
          
          if [[ "${{ steps.publishToOpenVSX.outputs.vsixPath }}" != "" ]]; then
            echo "VSIX file created: ${{ steps.publishToOpenVSX.outputs.vsixPath }}"
          fi
          
          if [[ "${{ steps.publishToOpenVSX.outcome }}" == "failure" && "${{ steps.publishToVSMarketplace.outcome }}" == "failure" ]]; then
            echo "âŒ Both deployments failed!"
            exit 1
          elif [[ "${{ steps.publishToOpenVSX.outcome }}" == "failure" ]]; then
            echo "âš ï¸ OpenVSX deployment failed, but VS Marketplace succeeded"
          elif [[ "${{ steps.publishToVSMarketplace.outcome }}" == "failure" ]]; then
            echo "âš ï¸ VS Marketplace deployment failed, but OpenVSX succeeded"
          else
            echo "âœ… Both deployments succeeded!"
          fi

      - name: Create Release
        if: success()
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate GitHub Changelog
        if: success()
        run: pnpx changelogithub
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create deployment summary
        if: always()
        run: |
          echo "## ðŸš€ Extension Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Release Information" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Release Status**: âœ… Created successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Registry | Status | Details |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŒ Open VSX Registry | ${{ steps.publishToOpenVSX.outcome == 'success' && 'âœ… Success' || 'âŒ Failed' }} | ${{ steps.publishToOpenVSX.outcome == 'success' && 'Published successfully' || 'Check logs for details' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸª Visual Studio Marketplace | ${{ steps.publishToVSMarketplace.outcome == 'success' && 'âœ… Success' || 'âŒ Failed' }} | ${{ steps.publishToVSMarketplace.outcome == 'success' && 'Published successfully' || 'Check logs for details' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ steps.publishToOpenVSX.outputs.vsixPath }}" != "" ]]; then
            echo "ðŸ“¦ **VSIX File**: \`${{ steps.publishToOpenVSX.outputs.vsixPath }}\`" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Configuration Used" >> $GITHUB_STEP_SUMMARY
          echo "- **Skip Duplicate**: âœ… Enabled" >> $GITHUB_STEP_SUMMARY
          echo "- **Dependencies Check**: âŒ Disabled (pnpm compatibility)" >> $GITHUB_STEP_SUMMARY
          echo "- **Shared VSIX**: âœ… Same file used for both registries" >> $GITHUB_STEP_SUMMARY
          echo "- **Release Notes**: âœ… Auto-generated" >> $GITHUB_STEP_SUMMARY
          echo "- **Changelog**: âœ… Generated via changelogithub" >> $GITHUB_STEP_SUMMARY
